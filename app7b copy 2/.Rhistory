df.all$nhi
df.after
df.before <- data.frame(
events = sg$Number.of.adverse.events.in.prev.12.mths,
nhi= sg$NHI,
type = 'before',
days = 365
)
df.before
df.before$events <-as.numeric (df.before$events)
df.after <- data.frame(
events = sg$Number.of.adverse.events.since.original.questionnaire,
nhi = sg$NHI,
type = 'after',
days = as.numeric(sg$days.between)
)
df.after$events <-as.numeric (df.after$events)
df.all<- rbind(df.before,df.after)
df.all
df.all$events
df.all$days <- as.numeric(df.all$days)
df.all$days
which(is.na(df.all$events))
m <- glmer(events ~ type + offset(log(days))  + (1|nhi),
family='poisson',
data=df.all)
anova(m,test="Chisq")
summary(m)
m <- glmer(events ~ type + offset(log(days))  + (1|nhi),
family='poisson',
data=df.all)
r <- residuals(m,type='pearson')
plot(r)
plot(r~df.all$type)
length(r)
dim(df.all)
qqnorm(r)
abline(0,1,col='red')
par(mfrow=c(4,5))
for (i in 1:19) {
sims <-simulate(m)
m.sim <- glmer(sims[[1]] ~ type + offset(log(days)) + (1|surname),
family='poisson',
data=df.all)
hist(residuals(m.sim))
}
par(mfrow=c(4,5))
for (i in 1:19) {
sims <-simulate(m)
m.sim <- glmer(sims[[1]] ~ type + offset(log(days)) + (1|nhi),
family='poisson',
data=df.all)
hist(residuals(m.sim))
}
par(mfrow=c(4,5))
for (i in 1:19) {
sims <-simulate(m)
m.sim <- glmer(sims[[1]] ~ type + offset(log(days)) + (1|nhi),
family='poisson',
data=df.all)
hist(residuals(m.sim))
}
hist(residuals(m))
sum(r)
summary(m)
summary(m)
m <- glmer(events ~ type + offset(log(days))  ,
family='poisson',
data=df.all)
m0 <- glm(events ~ type + offset(log(days))  ,
family='poisson',
data=df.all)
anova(m0,test="Chisq")
summary(m)
m <- glmer(events ~ type + offset(log(days))  + (1|nhi),
family='quasipoisson',
data=df.all)
m0 <- glm(events ~ type + offset(log(days))  ,
family='quasipoisson',
data=df.all)
summary(m)
m <- glm.nb(events ~ type   + offset(log(days)),
data=df.all)
m1 <- glm.nb(events ~ type   + offset(log(days)),
data=df.all)
summary(m1)
summary(m1)
exp(0.7)
confint(m)
exp(confint(m))
df.all$events <- as.character(df.all$events)
m0 <- glm(events ~ type + offset(log(days))  ,
family='quasipoisson',
data=df.all)
{
fname <- "Database for study findings -  Highlighted extra respondents Sept 2018.csv"
fpath <- "~/Documents/pumps/actionplans"
fullname <- paste(fpath,fname,sep='/')
d <- read.csv(fullname,na.strings=c("","NA"),
header=TRUE,stringsAsFactors = F)[1:174,]
# fix presumed typo
d[which(d$NHI=="CSC0048"),"First.FU.survey..waitlist.groups."] <-
"06/03/2016"
colnames(d)
simpName <- "Database for study findings -  Simplified Sept 2018.csv"
fullname <- paste(fpath,simpName,sep='/')
simp.df <- read.csv(fullname,na.strings=c("","NA"),
header=TRUE,stringsAsFactors = F)[1:174,]
colnames(simp.df)
simp.df$Number.of.adverse.events.since.original.questionnaire
dim(d)
d$dob.4 <- NA
for (i in 1:dim(d)[1]) {
dob <- d$DOB[i]
#dob <- "19/07/52"
dob.split <- strsplit(dob,'/')
day <- toString(dob.split[[1]][1])
month <- toString(dob.split[[1]][2])
yr <- toString(dob.split[[1]][3])
if (nchar(yr)==2) {
yr.num <- as.numeric(yr)
if (yr.num < 17) {
yyyy <- paste(20,yr,sep='')
} else {
yyyy <- paste(19,yr,sep='')
}
d$dob.4[i] <- paste(day,month,yyyy,sep='/')
} else {
d$dob.4[i] <- d$DOB[i]
}
}
d$age <- as.numeric(as.Date(d$Date.survey.completed,
format="%d/%m/%y")-as.Date(d$dob.4,format="%d/%m/%Y"))/365
# get from other spreadsheet until we know where to find it
d$Number.of.adverse.events.since.original.questionnaire <-
simp.df$Number.of.adverse.events.since.original.questionnaire
head(d$DOB)
head(d$dob.4)
d$fu.date <- NA
for (i in 1:dim(d)[1]) {
if (!is.na(d$First.FU.survey..waitlist.groups.[i])) {
d$fu.date[i] <- d$First.FU.survey..waitlist.groups.[i]
} else {
d$fu.date[i] <- d$FU.survey[i]
}
}
#head(d$fu.date[88])
length(which(!is.na(d$fu.date)))
# the study group:those who responded to a FU survey.
#   there should be 147
sg <- d[which(!is.na(d$fu.date)),]
dim(sg)
dim(simp.df)
d$inout <-"out"
d[which(d$NHI %in% sg$NHI),"inout"] <- "in"
table(d$inout)
dim(d)
chisq.test(d$Gender.1.M..2.F, d$inout)
t.test(d$age~d$inout)
# these are the ones in our t-tests
dim(sg)
# confidence in reliability of pump
m1 <- as.numeric(sg$Q36..Confidence.in.reliability.of.Pump)
m2 <- as.numeric(sg$Confidence.in.reliabilty.of.pump.FU)
length(which(!is.na(m1)))
length(which(!is.na(m2)))
t.test(m1,m2)
# Confidence.in.reliability.of.set.site
m3 <- as.numeric(sg$Q37..Confidence.in.reliability.of.set.site)
m4 <- as.numeric(sg$Confidence.in.reliabilty.of.set.site.FU)
length(which(!is.na(m3)))
length(which(!is.na(m4)))
t.test(m3,m4)
# Confidence.in.managing.in.pump.failure
m5 <- as.numeric(sg$Q40..Confidence.in.managing.in.pump.failure)
m6 <- as.numeric(sg$Confidence.in.managing.pump.failure.FU)
length(which(!is.na(m5)))
length(which(!is.na(m6)))
t.test(m5,m6)
#
m7 <- as.numeric(sg$Q41..How.anxious.about.pump.not.working)
m8 <- as.numeric(sg$How.anxious.FU)
length(which(!is.na(m7)))
length(which(!is.na(m8)))
t.test(m7,m8)
##
## adverse events
sg$Number.of.adverse.events.in.prev.12.mths
sg$day1 <- as.Date(sg$Date.survey.completed,format="%d/%m/%y")
head(sg$day1)
head(sg$Date.survey.completed)
sg$day1.str <- NA
for (i in 1:dim(sg)[1]) {
sg$day1.str[i] <- gsub("/20", "/", sg$Date.survey.completed[i])
sg$day2.str[i] <- gsub("/20", "/", sg$fu.date[i])
}
sg$day1 <- as.Date(sg$day1.str,format="%d/%m/%y")
sg$day2 <- as.Date(sg$day2.str,format="%d/%m/%y")
sg$days.between <- sg$day2 - sg$day1
plot(sg$days.between)
table(sg$days.between)
hist(as.numeric(sg$days.between))
range(sg$days.between,na.rm=T)
sg[which(sg$Number.of.adverse.events.since.original.questionnaire=="Several"),
"Number.of.adverse.events.since.original.questionnaire"] <- NA
sg[which(sg$Number.of.adverse.events.since.original.questionnaire=="several"),
"Number.of.adverse.events.since.original.questionnaire"] <- NA
# this is person 78, who had 147 days, ie. 21 weeks
sg[which(sg$Number.of.adverse.events.since.original.questionnaire=="a lot - 1-2 per week"),
"Number.of.adverse.events.since.original.questionnaire"] <- 30
sg[which(sg$Number.of.adverse.events.since.original.questionnaire=="4 to 5"),
"Number.of.adverse.events.since.original.questionnaire"] <- 5
sg[which(sg$Number.of.adverse.events.since.original.questionnaire=="No answer given"),
"Number.of.adverse.events.since.original.questionnaire"] <- NA
sg[which(sg$Number.of.adverse.events.since.original.questionnaire=="5 to 6"),
"Number.of.adverse.events.since.original.questionnaire"] <- 5
sg[which(sg$Number.of.adverse.events.since.original.questionnaire=="5-Jan"),
"Number.of.adverse.events.since.original.questionnaire"] <- NA
sg$First.FU.survey..waitlist.groups.
table(sg$Number.of.adverse.events.in.prev.12.mths)
table(sg$Number.of.adverse.events.since.original.questionnaire)
}
which(sg$Number.of.adverse.events.since.original.questionnaire==100)
sg[35,"Surname"]
sg <- sg[-35,]
dropm <- which(is.na(sg$Number.of.adverse.events.since.original.questionnaire))
length(dropm)
sg <- sg[-dropm,]
sg
sg$events.per.year <-as.numeric(sg$Number.of.adverse.events.since.original.questionnaire) * 365/ as.numeric(sg$days.between)
mean(sg$events.per.year)
mean(sg$Number.of.adverse.events.in.prev.12.mths)
df.before <- data.frame(
events = sg$Number.of.adverse.events.in.prev.12.mths,
nhi= sg$NHI,
type = 'before',
days = 365
)
df.before$events
df.before$events <-as.numeric (df.before$events)
df.after <- data.frame(
events = sg$Number.of.adverse.events.since.original.questionnaire,
nhi = sg$NHI,
type = 'after',
days = as.numeric(sg$days.between)
)
df.after$events <-as.numeric (df.after$events)
df.all<- rbind(df.before,df.after)
df.all$events <- as.numeric(df.all$events)
df.all$days
df.all$days <- as.numeric(df.all$days)
m0 <- glm(events ~ type + offset(log(days))  ,
family='quasipoisson',
data=df.all)
summary(m)
library(lme4)
m <- glmer(events ~ type + offset(log(days))  + (1|nhi),
family='poisson',
data=df.all)
df.all$type
m0 <- glm(events ~ type + offset(log(days))  ,
family='quasipoisson',
data=df.all)
library(lme4)
m <- glmer(events ~ type + offset(log(days))  + (1|nhi),
family='poisson',
data=df.all)
plot(df.all$events)
plot(df.all$events)
par(mfrow=c(1,1))
plot(df.all$events)
plot(no.per.day.before)
for (i in 1:no.per.day.after) {
points(no.per.day.after[i],col='red')
}
no.per.day.after
plot(no.per.day.before,ylim=c(0,0.5))
for (i in 1:no.per.day.after) {
points(no.per.day.after[i],col='red')
}
plot(no.per.day.before,ylim=c(0,0.2))
for (i in 1:no.per.day.after) {
points(no.per.day.after[i],col='red')
}
no.per.day.after
plot(no.per.day.before,ylim=c(0,0.2))
for (i in 1:no.per.day.after) {
points(i,no.per.day.after[i],col='red')
}
no.per.day.before
plot(no.per.day.after,ylim=c(0,1))
for (i in 1:no.per.day.before) {
points(i,no.per.day.before[i],colour='red')
}
plot(no.per.day.after,ylim=c(0,1))
for (i in 1:no.per.day.before) {
points(i,no.per.day.before[i],col='red')
}
plot(no.per.day.after,ylim=c(0,0.1))
for (i in 1:length(no.per.day.before)) {
points(i,no.per.day.before[i],col='red')
}
plot(no.per.day.after,ylim=c(0,0.1),col='red')
for (i in 1:length(no.per.day.before)) {
points(i,no.per.day.before[i],col='black')
}
summary(m)
m0 <- glm(events ~ factor(type) + offset(log(days))  ,
family='quasipoisson',
data=df.all)
summary(m)
{
fname <- "Database for study findings -  Highlighted extra respondents Sept 2018.csv"
fpath <- "~/Documents/pumps/actionplans"
fullname <- paste(fpath,fname,sep='/')
d <- read.csv(fullname,na.strings=c("","NA"),
header=TRUE,stringsAsFactors = F)[1:174,]
# fix presumed typo
d[which(d$NHI=="CSC0048"),"First.FU.survey..waitlist.groups."] <-
"06/03/2016"
colnames(d)
simpName <- "Database for study findings -  Simplified Sept 2018.csv"
fullname <- paste(fpath,simpName,sep='/')
simp.df <- read.csv(fullname,na.strings=c("","NA"),
header=TRUE,stringsAsFactors = F)[1:174,]
colnames(simp.df)
simp.df$Number.of.adverse.events.since.original.questionnaire
dim(d)
d$dob.4 <- NA
for (i in 1:dim(d)[1]) {
dob <- d$DOB[i]
#dob <- "19/07/52"
dob.split <- strsplit(dob,'/')
day <- toString(dob.split[[1]][1])
month <- toString(dob.split[[1]][2])
yr <- toString(dob.split[[1]][3])
if (nchar(yr)==2) {
yr.num <- as.numeric(yr)
if (yr.num < 17) {
yyyy <- paste(20,yr,sep='')
} else {
yyyy <- paste(19,yr,sep='')
}
d$dob.4[i] <- paste(day,month,yyyy,sep='/')
} else {
d$dob.4[i] <- d$DOB[i]
}
}
d$age <- as.numeric(as.Date(d$Date.survey.completed,
format="%d/%m/%y")-as.Date(d$dob.4,format="%d/%m/%Y"))/365
# get from other spreadsheet until we know where to find it
d$Number.of.adverse.events.since.original.questionnaire <-
simp.df$Number.of.adverse.events.since.original.questionnaire
head(d$DOB)
head(d$dob.4)
d$fu.date <- NA
for (i in 1:dim(d)[1]) {
if (!is.na(d$First.FU.survey..waitlist.groups.[i])) {
d$fu.date[i] <- d$First.FU.survey..waitlist.groups.[i]
} else {
d$fu.date[i] <- d$FU.survey[i]
}
}
#head(d$fu.date[88])
length(which(!is.na(d$fu.date)))
# the study group:those who responded to a FU survey.
#   there should be 147
sg <- d[which(!is.na(d$fu.date)),]
dim(sg)
dim(simp.df)
d$inout <-"out"
d[which(d$NHI %in% sg$NHI),"inout"] <- "in"
table(d$inout)
dim(d)
chisq.test(d$Gender.1.M..2.F, d$inout)
t.test(d$age~d$inout)
# these are the ones in our t-tests
dim(sg)
# confidence in reliability of pump
m1 <- as.numeric(sg$Q36..Confidence.in.reliability.of.Pump)
m2 <- as.numeric(sg$Confidence.in.reliabilty.of.pump.FU)
length(which(!is.na(m1)))
length(which(!is.na(m2)))
t.test(m1,m2)
# Confidence.in.reliability.of.set.site
m3 <- as.numeric(sg$Q37..Confidence.in.reliability.of.set.site)
m4 <- as.numeric(sg$Confidence.in.reliabilty.of.set.site.FU)
length(which(!is.na(m3)))
length(which(!is.na(m4)))
t.test(m3,m4)
# Confidence.in.managing.in.pump.failure
m5 <- as.numeric(sg$Q40..Confidence.in.managing.in.pump.failure)
m6 <- as.numeric(sg$Confidence.in.managing.pump.failure.FU)
length(which(!is.na(m5)))
length(which(!is.na(m6)))
t.test(m5,m6)
#
m7 <- as.numeric(sg$Q41..How.anxious.about.pump.not.working)
m8 <- as.numeric(sg$How.anxious.FU)
length(which(!is.na(m7)))
length(which(!is.na(m8)))
t.test(m7,m8)
##
## adverse events
sg$Number.of.adverse.events.in.prev.12.mths
sg$day1 <- as.Date(sg$Date.survey.completed,format="%d/%m/%y")
head(sg$day1)
head(sg$Date.survey.completed)
sg$day1.str <- NA
for (i in 1:dim(sg)[1]) {
sg$day1.str[i] <- gsub("/20", "/", sg$Date.survey.completed[i])
sg$day2.str[i] <- gsub("/20", "/", sg$fu.date[i])
}
sg$day1 <- as.Date(sg$day1.str,format="%d/%m/%y")
sg$day2 <- as.Date(sg$day2.str,format="%d/%m/%y")
sg$days.between <- sg$day2 - sg$day1
plot(sg$days.between)
table(sg$days.between)
hist(as.numeric(sg$days.between))
range(sg$days.between,na.rm=T)
sg[which(sg$Number.of.adverse.events.since.original.questionnaire=="Several"),
"Number.of.adverse.events.since.original.questionnaire"] <- NA
sg[which(sg$Number.of.adverse.events.since.original.questionnaire=="several"),
"Number.of.adverse.events.since.original.questionnaire"] <- NA
# this is person 78, who had 147 days, ie. 21 weeks
sg[which(sg$Number.of.adverse.events.since.original.questionnaire=="a lot - 1-2 per week"),
"Number.of.adverse.events.since.original.questionnaire"] <- 30
sg[which(sg$Number.of.adverse.events.since.original.questionnaire=="4 to 5"),
"Number.of.adverse.events.since.original.questionnaire"] <- 5
sg[which(sg$Number.of.adverse.events.since.original.questionnaire=="No answer given"),
"Number.of.adverse.events.since.original.questionnaire"] <- NA
sg[which(sg$Number.of.adverse.events.since.original.questionnaire=="5 to 6"),
"Number.of.adverse.events.since.original.questionnaire"] <- 5
sg[which(sg$Number.of.adverse.events.since.original.questionnaire=="5-Jan"),
"Number.of.adverse.events.since.original.questionnaire"] <- NA
sg$First.FU.survey..waitlist.groups.
table(sg$Number.of.adverse.events.in.prev.12.mths)
table(sg$Number.of.adverse.events.since.original.questionnaire)
}
sg[35,"Surname"]
sg <- sg[-35,]
dropm <- which(is.na(sg$Number.of.adverse.events.since.original.questionnaire))
length(dropm)
sg <- sg[-dropm,]
sg$events.per.year <-as.numeric(sg$Number.of.adverse.events.since.original.questionnaire) * 365/ as.numeric(sg$days.between)
mean(sg$events.per.year)
mean(sg$Number.of.adverse.events.in.prev.12.mths)
plot(sg$events.per.year~sg$Number.of.adverse.events.in.prev.12.mths,
pch='.')
plot(sg$Number.of.adverse.events.in.prev.12.mths,
sg$events.per.year
)
df.before <- data.frame(
events = sg$Number.of.adverse.events.in.prev.12.mths,
nhi= sg$NHI,
type = 'before',
days = 365
)
df.before$events <-as.numeric (df.before$events)
df.after <- data.frame(
events = sg$Number.of.adverse.events.since.original.questionnaire,
nhi = sg$NHI,
type = 'after',
days = as.numeric(sg$days.between)
)
df.after$events <-as.numeric (df.after$events)
df.all<- rbind(df.before,df.after)
df.all$events <- as.numeric(df.all$events)
df.all$days <- as.numeric(df.all$days)
m0 <- glm(events ~ factor(type) + offset(log(days))  ,
family='quasipoisson',
data=df.all)
anova(m0,test="Chisq")
summary(m)
max(df.before$events)
max(df.after$events)
plot(df.after$events~df.before$events)
plot(jitter(df.after$events)~jitter(df.before$events))
plot(no.per.day.after~no.per.day.before)
mean(no.per.day.before)
mean(no.per.day.after)
no.per.day.after
df.after$days
df.after$events
df.after$events / df.after$days
no.per.day.after  <-  df.after$events / df.after$days
no.per.day.after
mean(no.per.day.before)
mean(no.per.day.after)
head(df.before)
head(df.after)
df.before <- rbind(df.before,testr)
testr <- data.frame(
events = 8,
nhi= "666666",
type = 'before',
days = 365
)
df.before <- rbind(df.before,testr)
df.before
df.all<- rbind(df.before,df.after)
df.all$events <- as.numeric(df.all$events)
df.all$days <- as.numeric(df.all$days)
m <- glmer(events ~ type + offset(log(days))  + (1|nhi),
family='poisson',
data=df.all)
d <- read.csv(fullname,na.strings=c("","NA"),
header=TRUE,stringsAsFactors = F)[1:174,]
d[which(d$NHI=="CSC0048"),"Date.survey.completed"] <-
"06/12/2014"
options(shiny.reactlog=TRUE)
shiny::runApp('Documents/shiny/app7b')
